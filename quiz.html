<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz | Trading Book Club</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
        <!-- Chart Bars Left -->
    <div class="chart-bars chart-bars-left">
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
    </div>

    <!-- Chart Bars Right -->
    <div class="chart-bars chart-bars-right">
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
        <div class="chart-bar-group">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span>üìö</span>
                <span>BookClub</span>
            </a>
            
            <button class="nav-toggle" id="navToggle">‚ò∞</button>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" class="nav-link">üìä Dashboard</a></li>
                <li><a href="library.html" class="nav-link">üìö Library</a></li>
                <li><a href="notes.html" class="nav-link">üìù Notes</a></li>
                <li><a href="leaderboard.html" class="nav-link">üèÜ Leaderboard</a></li>
                <li><a href="badges.html" class="nav-link">üèÖ Badges</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div id="quiz-content">
            <!-- Populated by JS -->
        </div>
    </main>

    <footer class="footer">
        <p>¬© 2026 Trading Book Club. Level up your trading knowledge.</p>
    </footer>

    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Session persistence constants
        const SESSION_DURATION_DAYS = 7;
        const SESSION_KEY = 'bookclub_session';
        
        // Global variable to store current session
        let currentSession = null;
        
        function getStoredSession() {
            try {
                const session = localStorage.getItem(SESSION_KEY);
                if (!session) return null;
                
                const data = JSON.parse(session);
                const now = Date.now();
                const sessionAge = now - data.timestamp;
                const maxAge = SESSION_DURATION_DAYS * 24 * 60 * 60 * 1000;
                
                if (sessionAge > maxAge) {
                    localStorage.removeItem(SESSION_KEY);
                    return null;
                }
                return data;
            } catch (e) {
                return null;
            }
        }
        
        function syncSessionWithBookClub() {
            const session = getStoredSession();
            if (session) {
                // Store session globally for quiz submit
                currentSession = session;
                
                // FIX: Map session userId to actual user key
                // session.userId might be 'acro16hunna' or 'Dhianna369'
                // We need to find the matching user and use their id ('alex' or 'dhianna')
                const users = BookClub.getAllUsers ? BookClub.getAllUsers() : {};
                let matchedUserId = null;
                
                for (const [uid, udata] of Object.entries(users)) {
                    if (udata.discord_id === session.userId || 
                        udata.name === session.userName ||
                        uid === session.userId) {
                        matchedUserId = uid;
                        break;
                    }
                }
                
                // Use matched userId or fallback to name-based
                const effectiveUserId = matchedUserId || (session.userName === 'Alex' ? 'alex' : 'dhianna');
                
                // Sync session with BookClub's current user
                const expectedUserId = effectiveUserId;
                const currentBookClubUser = BookClub.getCurrentUser();
                if (!currentBookClubUser || currentBookClubUser.id !== expectedUserId) {
                    BookClub.setCurrentUser(expectedUserId);
                    console.log('Synced session to user:', expectedUserId);
                }
            } else {
                // Check for legacy format
                const legacyUser = localStorage.getItem('bookclub_whoami');
                if (legacyUser) {
                    const userId = legacyUser === 'Alex' ? 'alex' : 'dhianna';
                    const discordId = legacyUser === 'Alex' ? 'acro16hunna' : 'Dhianna369';
                    // Migrate to new session format with CORRECT userId
                    const newSession = {
                        userName: legacyUser,
                        userId: discordId, // Keep discord_id for reference
                        timestamp: Date.now()
                    };
                    localStorage.setItem(SESSION_KEY, JSON.stringify(newSession));
                    currentSession = newSession;
                    BookClub.setCurrentUser(userId); // Use correct user key
                    console.log('Migrated legacy user to:', userId);
                }
            }
        }
        
        // Sync session on load
        syncSessionWithBookClub();
        
        // DEBUG: Log session status
        console.log('=== QUIZ INITIALIZATION ===');
        console.log('Session:', currentSession);
        console.log('BookClub current user:', BookClub.getCurrentUser ? BookClub.getCurrentUser() : 'N/A');
        console.log('All users:', BookClub.getAllUsers ? BookClub.getAllUsers() : 'N/A');
        // Mobile Navigation Toggle
        document.getElementById('navToggle')?.addEventListener('click', function() {
            document.getElementById('navMenu').classList.toggle('active');
        });
        
        // Close mobile menu when clicking a link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navMenu').classList.remove('active');
            });
        });
        
        const API_URL = 'https://5-189-142-233.nip.io/api';
        let currentQuiz = null;
        let currentChapterId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const chapterId = parseInt(urlParams.get('chapter')) || 1;
            const retake = urlParams.get('retake') === 'true';
            
            loadQuiz(chapterId, retake);
        });

        function loadQuiz(chapterId, retake) {
            const chapter = BookClub.getChapterById(chapterId);
            const container = document.getElementById('quiz-content');
            
            if (!chapter) {
                container.innerHTML = '<div class="empty-state"><h2>Chapter not found</h2></div>';
                return;
            }
            
            const book = BookClub.getBookById(chapter.book_id);
            const quiz = BookClub.getQuizByChapter(chapterId);
            
            // Use session for user identification
            const session = getStoredSession();
            const userId = session ? session.userId : null;
            
            if (!quiz) {
                container.innerHTML = `
                    <div class="breadcrumb">
                        <a href="library.html">Library</a>
                        <span class="breadcrumb-separator">/</span>
                        <a href="book.html?id=${book.id}">${book.title}</a>
                        <span class="breadcrumb-separator">/</span>
                        <a href="chapter.html?id=${chapter.id}">Chapter ${chapter.number}</a>
                        <span class="breadcrumb-separator">/</span>
                        <span>Quiz</span>
                    </div>
                    <div class="empty-state-container">
                        <div class="empty-state-icon">üìù</div>
                        <h2>No Quiz Available</h2>
                        <p>There is no quiz for this chapter yet.</p>
                        <a href="chapter.html?id=${chapter.id}" class="btn btn-primary">Back to Chapter</a>
                    </div>
                `;
                return;
            }
            
            currentQuiz = quiz;
            currentChapterId = chapterId;
            
            const quizResult = userId ? BookClub.getQuizResult(userId, chapterId) : null;
            const hasTaken = quizResult && !retake;
            
            container.innerHTML = `
                <div class="breadcrumb">
                    <a href="library.html">Library</a>
                    <span class="breadcrumb-separator">/</span>
                    <a href="book.html?id=${book.id}">${book.title}</a>
                    <span class="breadcrumb-separator">/</span>
                    <a href="chapter.html?id=${chapter.id}">Chapter ${chapter.number}</a>
                    <span class="breadcrumb-separator">/</span>
                    <span>Quiz</span>
                </div>

                <div class="quiz-container">
                    <div class="quiz-header">
                        <h1>‚ùì Chapter Quiz</h1>
                        <p class="quiz-subtitle">${book.title} - Chapter ${chapter.number}: ${chapter.title}</p>
                    </div>

                    ${hasTaken ? `
                        <!-- Previous Results View -->
                        <div class="quiz-results" id="previous-results">
                            <div class="result-score-card">
                                <div class="result-emoji">
                                    ${quizResult.score >= 8 ? 'üéâ' : quizResult.score >= 6 ? 'üëç' : 'üìö'}
                                </div>
                                <div class="result-score">${quizResult.score}<span>/${quizResult.maxScore}</span></div>
                                <div class="result-percentage">${Math.round((quizResult.score / quizResult.maxScore) * 100)}%</div>
                                <div class="result-message">
                                    ${quizResult.score >= 9 ? 'Outstanding! You really know this material.' : 
                                      quizResult.score >= 8 ? 'Great job! You\'re mastering these concepts.' : 
                                      quizResult.score >= 6 ? 'Good work! Keep reviewing to improve.' : 
                                      'Keep learning! Review the chapter and try again.'}
                                    <br><span style="color: #22c55e; font-size: 0.9em;">üèÜ Chapter marked as read!</span>
                                </div>
                            </div>

                            <div class="result-actions">
                                <button class="btn btn-secondary" onclick="retakeQuiz()">
                                    üîÑ Retake Quiz
                                </button>
                                <a href="chapter.html?id=${chapter.id}" class="btn btn-primary">
                                    ‚Üê Back to Chapter
                                </a>
                            </div>
                            
                            <!-- Transparent Results Section -->
                            <div id="transparent-results-container"></div>
                        </div>
                    ` : ''}

                    <!-- Quiz Form -->
                    <div id="quiz-form-container" class="${hasTaken ? 'hidden' : ''}">
                        <form id="quiz-form" onsubmit="handleSubmit(event)">
                            ${quiz.questions.map((q, idx) => `
                                <div class="question-card" data-question="${idx}">
                                    <div class="question-number">Question ${idx + 1}</div>
                                    <h3 class="question-text">${q.question}</h3>
                                    
                                    <div class="options-list">
                                        ${q.options.map((opt, optIdx) => `
                                            <label class="option-label">
                                                <input type="radio" name="question_${idx}" value="${optIdx}" required>
                                                <span class="option-letter">${String.fromCharCode(65 + optIdx)}</span>
                                                <span class="option-text">${opt}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                    
                                    <div class="feedback" id="feedback-${idx}"></div>
                                </div>
                            `).join('')}

                            <div class="quiz-actions">
                                <button type="submit" id="submit-btn" class="btn btn-primary btn-lg">
                                    ‚úì Submit Quiz
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Results View -->
                    <div id="quiz-results" class="quiz-results hidden">
                        <div class="result-score-card">
                            <div class="result-emoji" id="result-emoji">üéâ</div>
                            <div class="result-score" id="result-score">0<span>/${quiz.questions.length}</span></div>
                            <div class="result-percentage" id="result-percentage">0%</div>
                            <div class="result-message" id="result-message">Great job!</div>
                        </div>

                        <div id="new-badges" class="new-badges"></div>

                        <div class="result-actions" style="justify-content: center;">
                            <a href="chapter.html?id=${chapter.id}" class="btn btn-primary" style="min-width: 200px; text-align: center;">
                                ‚Üê Back to Chapter
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            // If user has already taken the quiz, show transparent results
            if (hasTaken) {
                setTimeout(() => displayTransparentResults(), 100);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            console.log('=== HANDLE SUBMIT ===');
            console.log('Current quiz:', currentQuiz ? 'loaded' : 'null');
            console.log('Current chapter ID:', currentChapterId);
            
            if (!currentQuiz) {
                console.error('No quiz loaded!');
                return;
            }
            
            // Check for active session first
            const session = getStoredSession();
            console.log('Session from getStoredSession:', session);
            
            if (!session || !session.userId) {
                console.error('No session or userId!');
                BookClub.showNotification('Please log in first', 'error');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const answers = [];
            
            // Collect answers
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                const answer = formData.get(`question_${i}`);
                answers.push(answer ? parseInt(answer) : -1);
            }
            
            console.log('Collected answers:', answers);
            
            // Check all questions answered
            if (answers.some(a => a === -1)) {
                BookClub.showNotification('Please answer all questions', 'warning');
                return;
            }
            
            // Confirm submission
            if (!confirm('Submit your answers? You cannot change them after submission.')) {
                return;
            }
            
            // Show loading state - change text instead of spinner
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.dataset.originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Submitting...';
            submitBtn.disabled = true;
            
            // FIX: Find the correct userId to use (map from session to actual user key)
            const users = BookClub.getAllUsers ? BookClub.getAllUsers() : {};
            let effectiveUserId = session.userId;
            let effectiveUserName = session.userName;
            
            for (const [uid, udata] of Object.entries(users)) {
                if (udata.discord_id === session.userId || 
                    udata.name === session.userName) {
                    effectiveUserId = uid; // Use the actual user key (alex/dhianna)
                    effectiveUserName = udata.name;
                    break;
                }
            }
            
            console.log('Effective user for submission:', { effectiveUserId, effectiveUserName });
            
            // Submit quiz using session data
            const result = submitQuizWithSession(currentChapterId, answers, effectiveUserId, effectiveUserName);
            
            console.log('Submit result:', result);
            
            if (result) {
                // Auto-mark chapter as complete for the logged-in user
                const marked = await autoMarkChapter(currentChapterId, effectiveUserId, effectiveUserName);
                if (marked) {
                    // Add a note about auto-mark to the result message
                    result.autoMarked = true;
                }
                showResults(result);
                
                // Also show transparent results for both users
                setTimeout(() => displayTransparentResults(), 100);
                
                // Show success notification
                BookClub.showNotification(`Quiz completed! ${result.correct}/${result.total} correct (${result.percentage}%)`, 'success');
            } else {
                // Reset button if submission failed
                submitBtn.innerHTML = submitBtn.dataset.originalText;
                submitBtn.disabled = false;
                BookClub.showNotification('Failed to save quiz results. Please try again.', 'error');
            }
        }
        
        // Submit quiz with explicit session data
        function submitQuizWithSession(chapterId, answers, userId, userName) {
            console.log('=== SUBMIT QUIZ ===');
            console.log('Chapter ID:', chapterId);
            console.log('User ID from session:', userId);
            console.log('User Name from session:', userName);
            console.log('Answers:', answers);
            
            const quiz = BookClub.getQuizByChapter(chapterId);
            if (!quiz) {
                console.error('Quiz not found for chapter:', chapterId);
                return null;
            }
            
            // Calculate score
            let correct = 0;
            answers.forEach((answer, idx) => {
                if (answer === quiz.questions[idx].correct) {
                    correct++;
                }
            });
            
            const totalQuestions = quiz.questions.length;
            const score = Math.round((correct / totalQuestions) * 100); // Percentage score
            
            console.log('Calculated score:', correct, '/', totalQuestions, '(', score, '%)');
            
            // FIX: Get users and find by matching discord_id or name (not by userId directly)
            const STORAGE_KEYS_USER_DATA = 'bookclub_user_data';
            const users = JSON.parse(localStorage.getItem(STORAGE_KEYS_USER_DATA) || '{}');
            
            console.log('Available users:', Object.keys(users));
            
            // Find user by discord_id or name (case insensitive)
            let user = null;
            let actualUserId = null;
            
            // Try to find user by discord_id or name
            for (const [uid, udata] of Object.entries(users)) {
                const discordMatch = udata.discord_id && udata.discord_id.toLowerCase() === (userId || '').toLowerCase();
                const nameMatch = udata.name && udata.name.toLowerCase() === (userName || '').toLowerCase();
                const idMatch = uid.toLowerCase() === (userId || '').toLowerCase();
                
                console.log(`Checking user ${uid}: discord=${udata.discord_id}, name=${udata.name} -> discordMatch=${discordMatch}, nameMatch=${nameMatch}, idMatch=${idMatch}`);
                
                if (discordMatch || nameMatch || idMatch) {
                    user = udata;
                    actualUserId = uid;
                    console.log('Found matching user:', uid);
                    break;
                }
            }
            
            // If still not found, try to find by partial match on discord_id
            if (!user && userId) {
                for (const [uid, udata] of Object.entries(users)) {
                    if (udata.discord_id && udata.discord_id.toLowerCase().includes(userId.toLowerCase())) {
                        user = udata;
                        actualUserId = uid;
                        console.log('Found user by partial discord match:', uid);
                        break;
                    }
                }
            }
            
            if (!user) {
                console.error('User not found! Tried userId:', userId, 'userName:', userName);
                console.error('Available users:', Object.entries(users).map(([k,v]) => ({id: k, name: v.name, discord_id: v.discord_id})));
                
                // Create user on-the-fly if not found (fallback)
                console.log('Creating user on-the-fly as fallback...');
                const fallbackId = userName ? userName.toLowerCase() : 'unknown';
                user = {
                    id: fallbackId,
                    name: userName || 'Unknown',
                    discord_id: userId || '',
                    current_streak: 0,
                    longest_streak: 0,
                    chapters_read: 0,
                    badges: [],
                    quiz_scores: {},
                    notes: [],
                    last_read_date: null
                };
                actualUserId = fallbackId;
                users[fallbackId] = user;
            }
            
            // Initialize quiz_scores if not exists
            if (!user.quiz_scores) user.quiz_scores = {};
            
            // Save raw correct count (not percentage) for compatibility with app.js
            const rawScore = correct; // Number of correct answers (0-10)
            user.quiz_scores[chapterId] = Math.max(rawScore, user.quiz_scores[chapterId] || 0);
            
            // Save detailed result with answers (for transparency)
            if (!user.quiz_results) user.quiz_results = {};
            user.quiz_results[chapterId] = {
                score: rawScore, // Store raw count for display
                percentage: score, // Store percentage too
                answers: answers,
                completed_at: new Date().toISOString()
            };
            
            // Save back to localStorage
            localStorage.setItem(STORAGE_KEYS_USER_DATA, JSON.stringify(users));
            console.log('User data saved to localStorage');
            
            // Track activity - add to activities
            const activities = JSON.parse(localStorage.getItem('bookclub_activities') || '[]');
            activities.unshift({
                id: Date.now(),
                user_id: actualUserId,
                type: 'quiz_completed',
                data: { chapter_id: chapterId, score: rawScore },
                created_at: new Date().toISOString()
            });
            // Keep only last 50
            const trimmedActivities = activities.slice(0, 50);
            localStorage.setItem('bookclub_activities', JSON.stringify(trimmedActivities));
            console.log('Activity tracked');
            
            // Check for badges
            const newBadges = checkBadgesForUser(user);
            console.log('New badges:', newBadges);
            
            // Save user again in case badges were updated
            users[actualUserId] = user;
            localStorage.setItem(STORAGE_KEYS_USER_DATA, JSON.stringify(users));
            
            return {
                score: rawScore,
                maxScore: totalQuestions,
                percentage: score,
                correct: correct,
                total: totalQuestions,
                newBadges: newBadges.map(id => {
                    const badge = BookClub.getAllBadges().find(b => b.id === id);
                    return badge ? { id: badge.id, name: badge.name, emoji: badge.emoji } : null;
                }).filter(Boolean)
            };
        }
        
        // Helper function to check badges for a user
        function checkBadgesForUser(user) {
            const newBadges = [];
            const progress = BookClub.getProgress ? BookClub.getProgress(user.id) : {};
            const completedChapters = Object.keys(progress).length;
            
            const allBadges = BookClub.getAllBadges ? BookClub.getAllBadges() : [];
            
            allBadges.forEach(badge => {
                if (user.badges.includes(badge.id)) return;
                
                let earned = false;
                
                switch (badge.type) {
                    case 'chapters':
                        earned = completedChapters >= badge.target;
                        break;
                    case 'streak':
                        earned = user.current_streak >= badge.target;
                        break;
                    case 'perfect_quiz':
                        earned = Object.values(user.quiz_scores || {}).some(s => s === 10);
                        break;
                    case 'notes':
                        earned = user.notes.length >= badge.target;
                        break;
                    case 'books':
                        const bookChapters = {};
                        if (typeof BOOKCLUB_DATA !== 'undefined') {
                            BOOKCLUB_DATA.chapters.forEach(ch => {
                                if (!bookChapters[ch.book_id]) bookChapters[ch.book_id] = 0;
                                if (progress[ch.id]) bookChapters[ch.book_id]++;
                            });
                            earned = Object.values(bookChapters).some((count, idx) => {
                                const bookId = Object.keys(bookChapters)[idx];
                                const total = BOOKCLUB_DATA.chapters.filter(c => c.book_id === parseInt(bookId)).length;
                                return count >= total;
                            });
                        }
                        break;
                }
                
                if (earned) {
                    newBadges.push(badge.id);
                    user.badges.push(badge.id);
                }
            });
            
            return newBadges;
        }

        function showResults(result) {
            // Hide form, show results
            document.getElementById('quiz-form-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            
            // Update score display: "8/10 (80%)"
            document.getElementById('result-score').innerHTML = `${result.correct}<span>/${result.total}</span>`;
            document.getElementById('result-percentage').textContent = `${result.percentage}%`;
            
            // Set emoji and message
            const emojiEl = document.getElementById('result-emoji');
            const messageEl = document.getElementById('result-message');
            
            let message = '';
            if (result.percentage >= 90) {
                emojiEl.textContent = 'üéâ';
                message = 'Outstanding! You really know this material.';
            } else if (result.percentage >= 80) {
                emojiEl.textContent = 'üëç';
                message = 'Great job! You\'re mastering these concepts.';
            } else if (result.percentage >= 60) {
                emojiEl.textContent = 'üí™';
                message = 'Good work! Keep reviewing to improve.';
            } else {
                emojiEl.textContent = 'üìö';
                message = 'Keep learning! Review the chapter and try again.';
            }
            
            // Add auto-mark confirmation
            if (result.autoMarked) {
                message += ' \nüèÜ Chapter marked as read!';
            }
            messageEl.textContent = message;
            
            // Show new badges
            if (result.newBadges && result.newBadges.length > 0) {
                const badgesContainer = document.getElementById('new-badges');
                badgesContainer.innerHTML = `
                    <h3>üèÖ New Badges Earned!</h3>
                    ${result.newBadges.map(badge => `
                        <div class="badge-earned">
                            <span class="badge-emoji">${badge.emoji}</span>
                            <span class="badge-name">${badge.name}</span>
                        </div>
                    `).join('')}
                `;
            }
            
            // Scroll to results
            document.getElementById('quiz-results').scrollIntoView({ behavior: 'smooth' });
            
            // Show transparent results for both users
            displayTransparentResults();
        }
        
        // Display quiz results for both users (transparency)
        function displayTransparentResults() {
            const allResults = BookClub.getQuizResultsForChapter(currentChapterId);
            const users = BookClub.getAllUsers ? BookClub.getAllUsers() : {};
            
            // Find the appropriate container - either quiz-results or previous-results
            let transparentSection = document.getElementById('transparent-results');
            let container = document.getElementById('quiz-results');
            
            // If we're in previous-results view, use that container
            const previousResults = document.getElementById('previous-results');
            const transparentContainer = document.getElementById('transparent-results-container');
            
            if (transparentContainer) {
                // We're in the previous-results view
                transparentContainer.innerHTML = buildTransparentResultsHTML(allResults, users);
                return;
            }
            
            // Otherwise use the new results view
            if (!transparentSection) {
                transparentSection = document.createElement('div');
                transparentSection.id = 'transparent-results';
                transparentSection.className = 'transparent-results';
                transparentSection.style.cssText = 'margin-top: 2rem; padding: 1.5rem; background: rgba(30, 35, 50, 0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;';
                
                if (container) {
                    container.appendChild(transparentSection);
                }
            }
            
            transparentSection.innerHTML = buildTransparentResultsHTML(allResults, users);
        }
        
        // Build HTML for transparent results
        function buildTransparentResultsHTML(allResults, users) {
            let resultsHTML = `
                <div style="margin-bottom: 1rem; font-size: 14px; color: #8b9bb4; text-align: center;">
                    üë• Quiz Results - Transparent View
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
            `;
            
            Object.keys(allResults).forEach(userId => {
                const result = allResults[userId];
                const isAlex = result.name === 'Alex';
                const color = isAlex ? '#00d4aa' : '#ff6b6b';
                const avatar = isAlex ? 'üë®' : 'üë©';
                
                resultsHTML += `
                    <div style="flex: 1; min-width: 200px; max-width: 300px; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 3px solid ${color};">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                            <span style="font-size: 20px;">${avatar}</span>
                            <span style="font-weight: 600; color: ${color};">${result.name}</span>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: white;">
                            ${result.score}/${currentQuiz.questions.length}
                            <span style="font-size: 14px; font-weight: 400; color: #8b9bb4;">(${Math.round((result.score / currentQuiz.questions.length) * 100)}%)</span>
                        </div>
                        ${result.completed_at ? `
                            <div style="font-size: 11px; color: #6b7a94; margin-top: 4px;">
                                Completed ${new Date(result.completed_at).toLocaleDateString()}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Add "Not taken yet" for users without results
            Object.keys(users).forEach(userId => {
                if (!allResults[userId]) {
                    const user = users[userId];
                    const isAlex = user.name === 'Alex';
                    const color = isAlex ? '#00d4aa' : '#ff6b6b';
                    const avatar = isAlex ? 'üë®' : 'üë©';
                    
                    resultsHTML += `
                        <div style="flex: 1; min-width: 200px; max-width: 300px; padding: 1rem; background: rgba(0,0,0,0.1); border-radius: 8px; border-left: 3px solid rgba(139, 155, 180, 0.3); opacity: 0.6;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                                <span style="font-size: 20px;">${avatar}</span>
                                <span style="font-weight: 600; color: ${color};">${user.name}</span>
                            </div>
                            <div style="font-size: 14px; color: #6b7a94; font-style: italic;">
                                ‚óã Not taken yet
                            </div>
                        </div>
                    `;
                }
            });
            
            resultsHTML += '</div>';
            return resultsHTML;
        }

        function retakeQuiz() {
            document.getElementById('previous-results').classList.add('hidden');
            document.getElementById('quiz-form-container').classList.remove('hidden');
            document.getElementById('quiz-form').reset();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Auto-mark chapter as complete when quiz is submitted
        async function autoMarkChapter(chapterId, userId, userName) {
            console.log('=== AUTO MARK CHAPTER ===');
            console.log('Chapter ID:', chapterId, 'User ID:', userId, 'User Name:', userName);
            
            if (!userId || !userName) {
                console.log('No user logged in, skipping auto-mark');
                return false;
            }

            // FIX: Ensure we use the correct userId for localStorage
            // userId might be 'alex' or 'dhianna' - that's correct
            // But we need to ensure the progress key matches
            const effectiveUserId = userId; // Already should be 'alex' or 'dhianna'
            
            let apiSuccess = false;
            let localSuccess = false;

            // 1. Update localStorage immediately for instant UI feedback
            try {
                const STORAGE_KEYS_PROGRESS = 'bookclub_progress';
                const allProgress = JSON.parse(localStorage.getItem(STORAGE_KEYS_PROGRESS) || '{}');
                if (!allProgress[effectiveUserId]) allProgress[effectiveUserId] = {};
                
                allProgress[effectiveUserId][chapterId] = {
                    completed: true,
                    completed_at: new Date().toISOString(),
                    notes: `Completed via quiz on ${new Date().toLocaleDateString()}`
                };
                
                localStorage.setItem(STORAGE_KEYS_PROGRESS, JSON.stringify(allProgress));
                localSuccess = true;
                console.log(`‚úì Local progress updated for ${userName} (ID: ${effectiveUserId}), chapter ${chapterId}`);
            } catch (e) {
                console.error('Error updating local progress:', e);
            }

            // 2. Also sync with API (using discord_id if available)
            try {
                // Try to get discord_id from user data
                const users = BookClub.getAllUsers ? BookClub.getAllUsers() : {};
                const userData = users[effectiveUserId];
                const discordId = userData?.discord_id || effectiveUserId;
                
                const response = await fetch(`${API_URL}/user/${discordId}/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: userName,
                        chapter_id: chapterId,
                        completed: true,
                        notes: `Completed via quiz on ${new Date().toLocaleDateString()}`
                    })
                });

                if (response.ok) {
                    console.log(`‚úì API: Auto-marked chapter ${chapterId} as complete for ${userName}`);
                    apiSuccess = true;
                } else {
                    console.error('Auto-mark API call failed:', response.status);
                }
            } catch (e) {
                console.error('Error auto-marking chapter via API:', e);
            }
            
            return localSuccess || apiSuccess;
        }
    </script>
</body>
</html>
